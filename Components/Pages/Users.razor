@page "/users"
@using blazor.Services
@inject DbService DbService
@inject UserService UserService
@rendermode InteractiveServer
@inject ISnackbar Snackbar

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<PageTitle>Users</PageTitle>
<style>
    .hidden {
        visibility: hidden;
    }
</style>
@if(users == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudMainContent>
        <MudContainer>
            <MudDataGrid Items="@users" T="RenderedUser" PageSize="10" Sortable="true" Filterable="true" Search="true">
                <Columns >
                    <PropertyColumn Property="x => x.Id" Title="Id">
                        <CellTemplate Context="context">
                            <MudText Typo="Typo.body1" 
                                @onmouseover="() => ShowProfileCard(context.Item)" 
                                @onmouseout="() => StartHideProfileCardTimer(context.Item)"
                            >
                                @context.Item.Id
                            </MudText>
                            @if(context.Item.ShowProfileCard)
                            {
                                <blazor.Components.Components.ProfileCard User="context.Item" />
                            }
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.Username" Title="Username" />
                    <PropertyColumn Title="Email" Property="x => x.Email">
                        <CellTemplate Context="context" >
                            @if(context.Item.ShowEdit)
                            {
                                <MudTextField 
                                    Typo="Typo.body1" 
                                    @bind-Value="context.Item.Email" 
                                    onValueChanged="context.OnValueChanged" 
                                    OnBlur="async () => await HandleLeave(context.Item)"
                                />
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" @onclick="() => context.Item.ToggleEditMode()">@context.Item.Email</MudText>
                            }
                        </CellTemplate>
                    </PropertyColumn>
                </Columns>
            </MudDataGrid>
        </MudContainer>
    </MudMainContent>
}

@code {
    private List<RenderedUser> users { get; set; }
    private RenderedUser userProfileShown { get; set; }
    public Timer hoverTimer;

    protected override async Task OnInitializedAsync()
    {
        // Simulate asynchronous loading to demonstrate streaming rendering
        await Task.Delay(500);
        var fetchedUsers = await UserService.GetUsers();

        // Turn into RenderedUser
        users = fetchedUsers.Select(user => new RenderedUser
        {
            Id = user.Id,
            Username = user.Username,
            Email = user.Email
        }).ToList();
    }

    public async Task HandleLeave(RenderedUser user)
    {
        user.ToggleEditMode();

        // Save changes
        await UserService.UpdateUser(user);

        Snackbar.Add("Saved", Severity.Success, config =>
        {
            config.VisibleStateDuration = 500;
            config.HideTransitionDuration = 200;
            config.ShowTransitionDuration = 200;
        });
        StateHasChanged();
    }

    private void ShowProfileCard(RenderedUser user)
    {
        if (userProfileShown != null)
        {
            userProfileShown.ShowProfileCard = false;
        }
        userProfileShown = user;
        userProfileShown.ShowProfileCard = true;
        StateHasChanged();
    }
    public void StartHideProfileCardTimer(RenderedUser user)
    {
        hoverTimer?.Dispose();
        hoverTimer = new Timer(_ => HideProfileCard(user), null, 2000, Timeout.Infinite);
    }
    private void HideProfileCard(RenderedUser user)
    {
        if (userProfileShown == user)
        {
            userProfileShown.ShowProfileCard = false;
            userProfileShown = null;
            StateHasChanged();
        }
    }
}

